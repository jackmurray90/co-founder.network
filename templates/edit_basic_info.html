{% extends 'base.html' %}
{% block head %}
  <link  href="/cropper.min.css" rel="stylesheet"/>
  <script src="/cropper.min.js"></script>
  <style>
    .nowrap { white-space: nowrap; }
    #working-profile-picture { display: block; max-width: 10em; max-height: 10em; }
  </style>
  <script>
    function check_username() {
      const username = document.getElementsByName('username')[0];
      if (document.getElementsByName("username")[0].value.match(/[^a-z0-9-]/g) || !document.getElementsByName("username")[0].value.match(/[a-z]/g)) {
        document.getElementById('submit').disabled = true;
        document.getElementById("error").textContent = "{{ tr['invalid_username'] }}";
      } else {
        document.getElementById('submit').disabled = false;
        document.getElementById("error").textContent = '';
      }
    }
    let cropper = null;
    function readURL(input) {
      if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById('working-profile-picture').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
        setTimeout(function() {
          if (cropper) cropper.destroy();
          cropper = new Cropper(document.getElementById('working-profile-picture'), { aspectRatio: 1 / 1 });
          document.getElementById('cropper').className = '';
          document.getElementById('crop-button').className = '';
          document.getElementById('message').innerText = '';
        }, 1000);
      }
    }
    function crop() {
      cropper.getCroppedCanvas().toBlob(async function (blob) {
        document.getElementById('cropper').className = 'hide';
        document.getElementById('crop-button').className = 'hide';
        if (blob.size > 1024*1024*2) {
          document.getElementById('message').innerText = '{{ tr["picture_too_large"] }}';
          return;
        }
        const formData = new FormData();
        formData.append('image', blob);
        formData.append('api_key', '{{ user.api_key }}');
        await fetch('/cv/set-profile-picture', {
          method: 'POST',
          body: formData
        });
        document.getElementById('profile-picture').src = "/profile_pictures/{{ user.id }}.png?" + new Date().getTime();
        document.getElementById('message').innerText = '{{ tr["picture_success"] }}';
      });
    }
  </script>
{% endblock %}
{% block content %}
<div id="content">
  {% if message %}
    <p>{{ message }}</p>
  {% endif %}
  <table>
    <tr>
      <th>{{ tr['username'] }}</th>
      <td>
        <form action="/cv/set-username" method="post">
          {{ csrf|safe }}
          <input name="username" maxlength="30" onKeyUp="check_username()" value="{% if user.username %}{{ user.username }}{% endif %}"/>
          <input id="submit" type="submit" value="{{ tr['claim_username'] }}"/>
          <span id="error"></span>
        </form>
      </td>
    </tr>
  </table>
  <form>
    <table>
      <tr>
        <th>{{ tr['profile_picture'] }}</th>
        <td class="center">
          <img id='profile-picture' src="/profile_pictures/{% if profile_picture_exists %}{{ user.id }}{% else %}grey{% endif %}.png"/><br/>
          <input type="file" name="image" id="image" onChange="readURL(this);"/>
        </td>
        <td>
          <div id='cropper' class='hide'><img id="working-profile-picture" src="#" alt="Profile Picture" /></div>
          <div id='crop-button' class='hide'><p class="center"><button type="button" onClick="crop();">Crop</button></p></div>
          <p id="message"></p>
        </td>
      </tr>
  </form>
  <form id="form" action="/cv/edit-basic-info" method="post">
    {{ csrf|safe }}
    <table class="wide">
      <tr><th>{{ tr['name'] }}</th><td><input name="name" maxlength="80" value="{{ user.name }}"/></td></tr>
      <tr><th>{{ tr['phone_optional'] }}</th><td><input name="phone" maxlength="80" value="{{ user.phone }}"/></td></tr>
      <tr><th>{{ tr['profile_summary'] }}</th><td class="wide"><textarea name="summary" class="wide" maxlength="1000">{{ user.summary }}</textarea></td></tr>
      <tr><th>{{ tr['email_address'] }}</th><td>{{ user.email }} <span class="nowrap"><input {% if user.show_email %}checked{% endif %} type="checkbox" name="show_email" value="true"/> {{ tr['show_email'] }}</span></td></tr>
      <tr><th>{{ tr['open_to_work'] }}</th><td><input {% if user.open %}checked{% endif %} type="checkbox" name="open" value="true"/></td></tr>
    </table>
    <p><input type="submit" value="{{ tr['save_changes'] }}"/></p>
  </form>
  <p><a href="/cv/delete">{{ tr['delete_my_account'] }}</a></p>
</div>
{% endblock %}
